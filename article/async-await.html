<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />
<link rel="stylesheet" href="/_assets/main.css" />

    <title>async / await - tjmerlin</title>
  <link rel="stylesheet" href="/_markdown_plugin_assets/highlight.js/atom-one-light.css" /></head>
  <body>
    <div class="main">
      <nav class="navigation">
        <a href="/">tjmerlin</a>
      </nav>
      <article>
        <header>
          <h1 class="article-title">async / await</h1>
          <div class="article-info">
            <div>
              <span
                >Created At：<time datetime="1669557030031"
                  >2022-11-27 21:50</time
                ></span
              >
              <span
                >Updated At：<time datetime="1669557972356"
                  >2022-11-27 22:06</time
                ></span
              >
            </div>
            
          </div>
        </header>
        <div class="article-content markdown-body"><h2 id="async-await">async / await</h2>
<blockquote>
<p><code>async</code> / <code>await</code> 是未来，<code>@asyncio.coroutine</code> / <code>yield from</code> 是历史。</p>
</blockquote>
<hr />
<p>进程、线程、协程的区别：</p>
<p>进程是独立的进程，有自己的命名空间执行，可以 ps aux 看到<br />
一个进程可有多个线程去执行，由操作系统来决定进行线程执行状态切换，不能通过 ps aux 看到线程<br />
协程是由用户手动控制的执行在线程中的逻辑，占用资源更小，执行效率更快（因为不需要频繁切换进程、线程），但是有一定的开发能力的要求。</p>
<p>最早，在 <code>Node.js</code> 等语言中，都是使用了 <code>yield</code> / <code>yield from</code> 等方式来做到协程的，后续增加了语法糖：<code>async</code> / <code>await</code> 用于协程开发。</p>
<hr />
<p>python 中一个简单的例子：</p>
<div><pre class="hljs"><code><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 引入 asyncio 启动了异步语法糖工具</span>

<span class="hljs-comment"># 标示为一个异步协程函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hello world'</span>)
    <span class="hljs-comment"># 等待 asyncio.sleep(1)</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hello again!'</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">r</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        <span class="hljs-built_in">print</span>(i)
        <span class="hljs-keyword">await</span> hello()

<span class="hljs-comment"># 启动异步 event_loop</span>
loop = asyncio.get_event_loop()
<span class="hljs-comment"># 执行等待完成</span>
loop.run_until_complete(r())
loop.close()</code></pre></div>
<p>python3 中如果看到了 <code>@asyncio.coroutine</code> 和 <code>yield from</code> 同时出现，可以考虑脑补为 <code>async</code> / <code>await</code></p>
<p>如上脚本可修改为：</p>
<div><pre class="hljs"><code><span class="hljs-keyword">import</span> asyncio

<span class="hljs-meta">@asyncio.coroutine</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">hello</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hello world'</span>)
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> asyncio.sleep(<span class="hljs-number">1</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'hello again!'</span>)

<span class="hljs-meta">@asyncio.coroutine</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">r</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
        <span class="hljs-built_in">print</span>(i)
        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> hello()

loop = asyncio.get_event_loop()
loop.run_until_complete(r())
loop.close()</code></pre></div>
<p>在 <code>Python3.8</code> 中会提示 <code>@coroutine" decorator is deprecated</code>。Python3.8 开始，废弃掉了 <code>@asyncio.coroutine</code> 写法。</p>
</div>
      </article>
    </div>
  </body>
</html>
